<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>List of Candidatures</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .container {
      max-width: 900px;
      margin-top: 50px;
      padding: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .table thead {
      background-color: #f1f1f1;
    }
    .btn {
      border-radius: 8px;
    }
  </style>
</head>
<body>

<div class="container">
  <h2 class="text-center text-success">List of Candidatures</h2>
  <table class="table table-striped">
    <thead>
    <tr>
      <th scope="col">Student ID</th>
      <th scope="col">Email</th>
      <th scope="col">Internship</th>
      <th scope="col">Status</th>
      <th scope="col">CV</th>
      <th scope="col">Actions</th>
    </tr>
    </thead>
    <tbody id="applicationTableBody">
    <!-- Application data will be dynamically inserted here -->
    </tbody>
  </table>
  <a href="index.html" class="btn btn-secondary w-100">Back to Dashboard</a>
</div>

<script>
  // Fetch the list of applications (candidatures) from the backend
  fetch('http://localhost:8080/application/listApplications')
          .then(response => response.json())
          .then(data => {
            const tableBody = document.getElementById('applicationTableBody');
            data.forEach(application => {
              const row = document.createElement('tr');
              row.setAttribute('data-id', application.id); // Store the application ID as a data attribute for easy access
              row.innerHTML = `
          <td>${application.studentId}</td>
          <td>${application.email}</td>
          <td>${application.internship.title}</td> <!-- Assuming Internship has a 'title' field -->
          <td>
            <select class="form-select" id="status-${application.id}">
              <option value="PENDING" ${application.status === 'PENDING' ? 'selected' : ''}>Pending</option>
              <option value="ACCEPTED" ${application.status === 'ACCEPTED' ? 'selected' : ''}>Accepted</option>
              <option value="REJECTED" ${application.status === 'REJECTED' ? 'selected' : ''}>Rejected</option>
            </select>
          </td>
          <td>
            <a href="http://localhost:8080/application/cv/${application.cv}" class="btn btn-info btn-sm" target="_blank">Download CV</a>
          </td>
          <td>
            <button class="btn btn-warning btn-sm" onclick="updateStatus(${application.id}, this)">Update Status</button>
            <button class="btn btn-danger btn-sm" onclick="deleteApplication(${application.id}, this)">Delete</button>
          </td>
        `;
              tableBody.appendChild(row);
            });
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Failed to load applications.');
          });

  // Function to handle application deletion
  function deleteApplication(id, button) {
    if (confirm('Are you sure you want to delete this application?')) {
      fetch(`http://localhost:8080/application/deleteApplication/${id}`, {
        method: 'DELETE',
      })
              .then(response => {
                if (response.ok) {
                  // Find the closest <tr> and remove it from the table
                  const row = button.closest('tr');
                  row.remove();
                  alert('Application deleted successfully!');
                } else {
                  alert('Failed to delete application.');
                }
              })
              .catch(error => {
                console.error('Error:', error);
                alert('Failed to delete application.');
              });
    }
  }

  // Function to handle updating application status
  function updateStatus(id, button) {
    const statusDropdown = document.getElementById(`status-${id}`);
    const newStatus = statusDropdown.value;

    fetch(`http://localhost:8080/application/updateStatus/${id}?status=${newStatus}`, {
      method: 'PUT',
    })
            .then(response => response.json())
            .then(updatedApplication => {
              alert('Application status updated successfully!');
              button.closest('tr').cells[3].textContent = updatedApplication.status; // Update status in the table
            })
            .catch(error => {
              console.error('Error:', error);
              alert('Failed to update application status.');
            });
  }
</script>

</body>
</html>
